// app/api/auth/otp/request/route.ts
import { NextRequest, NextResponse } from "next/server";
import { createSupabaseRouteClient } from "@/lib/supabaseRouteClient";
import { prisma } from "@/lib/prisma";
import { generateOtpCode, hashOtpCode } from "@/lib/otp";
// If you already have a mailer util, import that instead
import { Resend } from "resend";

const resend = process.env.RESEND_API_KEY
  ? new Resend(process.env.RESEND_API_KEY)
  : null;

export async function POST(req: NextRequest) {
  const { supabase, res } = createSupabaseRouteClient(req);

  const {
    data: { user },
    error: userError,
  } = await supabase.auth.getUser();

  if (userError || !user?.email) {
    return NextResponse.json(
      { error: "Not authenticated" },
      { status: 401 }
    );
  }

  const email = user.email;
  const userId = user.id;

  // Generate OTP
  const code = generateOtpCode();
  const codeHash = hashOtpCode(code);

  const now = new Date();
  const expiresAt = new Date(now.getTime() + 10 * 60 * 1000); // 10 minutes

  // Optional: clean up old codes for this user
  await prisma.atsLoginOtp.deleteMany({
    where: {
      userId,
      OR: [{ usedAt: { not: null } }, { expiresAt: { lt: now } }],
    },
  });

  await prisma.atsLoginOtp.create({
    data: {
      userId,
      email,
      codeHash,
      expiresAt,
    },
  });

  // Send email (or log in dev)
  if (resend) {
    await resend.emails.send({
      from: "ThinkATS <no-reply@thinkats.com>",
      to: email,
      subject: "Your ThinkATS login code",
      text: `Your one-time ThinkATS login code is: ${code}\n\nThis code expires in 10 minutes.`,
    });
  } else {
    console.log(
      "[ThinkATS OTP] RESEND_API_KEY not set. OTP for",
      email,
      "is",
      code
    );
  }

  // We must return a response that carries any updated Supabase cookies
  const json = NextResponse.json(
    { ok: true },
    {
      status: 200,
    }
  );

  // copy over cookies set on `res`
  res.cookies.getAll().forEach((cookie) => {
    json.cookies.set(cookie);
  });

  return json;
}
