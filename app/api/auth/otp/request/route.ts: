// app/api/auth/otp/request/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { createSupabaseRouteClient } from "@/lib/supabaseRouteClient";
import { Resend } from "resend";

export const dynamic = "force-dynamic";

const resend = new Resend(process.env.RESEND_API_KEY);

// You’ve already set RESEND_FROM_EMAIL on Vercel as a ThinkATS address
const FROM_EMAIL =
  process.env.RESEND_FROM_EMAIL || "ThinkATS <no-reply@thinkats.com>";

function generateOtpCode(): string {
  // 6-digit numeric OTP
  return Math.floor(100000 + Math.random() * 900000).toString();
}

export async function POST(_req: NextRequest) {
  try {
    // 1) Get current Supabase user
    const supabase = createSupabaseRouteClient();

    const {
      data: { user },
      error: userError,
    } = await supabase.auth.getUser();

    if (userError || !user || !user.email) {
      return NextResponse.json(
        {
          ok: false,
          error: "You need to be signed in before requesting a sign-in code.",
        },
        { status: 401 },
      );
    }

    const email = user.email.toLowerCase();

    // 2) Find or create app-level User row tied to this email
    let appUser = await prisma.user.findUnique({
      where: { email },
    });

    if (!appUser) {
      appUser = await prisma.user.create({
        data: {
          email,
          fullName:
            (user.user_metadata &&
              (user.user_metadata.full_name ||
                user.user_metadata.name)) ||
            null,
          globalRole: "USER",
        },
      });
    }

    // 3) Invalidate any existing, still-valid OTPs for this user
    await prisma.loginOtp.updateMany({
      where: {
        userId: appUser.id,
        consumed: false,
        expiresAt: { gt: new Date() },
      },
      data: {
        consumed: true,
      },
    });

    // 4) Create a fresh OTP
    const code = generateOtpCode();
    const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes

    await prisma.loginOtp.create({
      data: {
        userId: appUser.id,
        code,
        expiresAt,
      },
    });

    // 5) Send via email (Resend)
    if (!process.env.RESEND_API_KEY) {
      console.error("[ThinkATS OTP] RESEND_API_KEY missing.");
      return NextResponse.json(
        {
          ok: false,
          error:
            "Email sending for OTP is not configured (RESEND_API_KEY is missing).",
        },
        { status: 500 },
      );
    }

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: email,
        subject: "Your ThinkATS sign-in code",
        html: `
          <div style="font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 24px; color: #0f172a;">
            <h1 style="font-size: 20px; margin-bottom: 8px;">Your ThinkATS login code</h1>
            <p style="font-size: 14px; margin: 0 0 16px;">Use this one-time code to complete your sign in:</p>
            <p style="font-size: 32px; font-weight: 700; letter-spacing: 0.3em; margin: 0 0 16px;">
              ${code}
            </p>
            <p style="font-size: 12px; color: #64748b; margin: 0;">
              This code will expire in 10 minutes. If you did not request it, you can safely ignore this email.
            </p>
          </div>
        `,
      });

      console.log("[ThinkATS OTP] Resend response:", result);
    } catch (err: any) {
      console.error("[ThinkATS OTP] Failed to send OTP email:", err);

      const messageFromError =
        typeof err?.message === "string"
          ? err.message
          : typeof err === "string"
          ? err
          : "We couldn’t send the sign-in code email. Please try again in a moment.";

      return NextResponse.json(
        { ok: false, error: messageFromError },
        { status: 500 },
      );
    }

    return NextResponse.json({ ok: true });
  } catch (err) {
    console.error("[ThinkATS OTP] Request error:", err);
    return NextResponse.json(
      {
        ok: false,
        error:
          "Something went wrong while requesting your sign-in code. Please try again.",
      },
      { status: 500 },
    );
  }
}
