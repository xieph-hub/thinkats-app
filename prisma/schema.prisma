generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // Supabase pooled URL
  directUrl = env("DIRECT_URL")     // Supabase direct URL
}

// --------------------------------------------------------------------------
// TENANTS
// --------------------------------------------------------------------------

model Tenant {
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug                String      @unique
  name                String
  status              String      @default("active")
  primaryContactEmail String?     @map("primary_contact_email")
  notificationEmail   String?     @map("notification_email") // where digests / ATS alerts can go
  plan                String      @default("free") @db.Text   // free, pro, enterprise, etc.
  trialEndsAt         DateTime?   @map("trial_ends_at") @db.Timestamptz(6)

  // Scoring + hiring configuration
  hiringMode    String @map("hiring_mode") @default("balanced") // volume | executive | balanced
  scoringConfig Json?  @map("scoring_config")                    // tenant-level weights/thresholds

  internalNotes String?   @map("notes")
  logoUrl       String?   @map("logo_url")
  createdAt     DateTime  @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @map("updated_at") @default(now()) @db.Timestamptz(6)

  // Relations
  jobs               Job[]
  clientCompanies    ClientCompany[]
  candidates         Candidate[]
  stages             JobStage[]
  careerSiteSettings CareerSiteSettings[]
  activityLog        ActivityLog[]
  emailTemplates     EmailTemplate[]
  candidateTags      CandidateTag[]
  notes              Note[]
  sentEmails         SentEmail[]
  userTenantRoles    UserTenantRole[]
  tags               Tag[]

  // scoring audit trail
  scoringEvents ScoringEvent[]

  // search / views / analytics
  savedViews         SavedView[]
  analyticsSnapshots AnalyticsSnapshot[]

  @@map("tenants")
}

// --------------------------------------------------------------------------
// USERS & USER ↔ TENANT ROLES
// --------------------------------------------------------------------------

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName     String?  @map("full_name")
  email        String?  @unique
  passwordHash String?  @map("password_hash")
  globalRole   String   @map("global_role") @default("USER") // SUPER_ADMIN / USER
  isActive     Boolean  @map("is_active") @default(true)
  createdAt    DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  userTenantRoles UserTenantRole[]
  loginOtps       LoginOtp[]      // OTP records for this user

  // NEW: back-relation for SavedView.owner
  savedViews      SavedView[]

  @@map("users")
}

model UserTenantRole {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  role      String
  isPrimary Boolean  @map("is_primary") @default(false)
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("user_tenant_roles")
}

// --------------------------------------------------------------------------
// LOGIN OTPs
// --------------------------------------------------------------------------

model LoginOtp {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  code      String
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  consumed  Boolean  @default(false)
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id])

  @@map("login_otps")
  @@index([userId, consumed, expiresAt], map: "idx_login_otps_user_active")
}

// --------------------------------------------------------------------------
// CLIENT COMPANIES
// --------------------------------------------------------------------------

model ClientCompany {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String  @map("tenant_id") @db.Uuid
  name     String
  slug     String?
  logoUrl  String? @map("logo_url")

  // New richer fields
  website  String? @map("website")
  industry String? @map("industry")

  // Careersite configuration for this client
  careersiteSlug         String? @map("careersite_slug")
  careersiteCustomDomain String? @map("careersite_custom_domain")
  careersiteEnabled      Boolean @map("careersite_enabled") @default(false)

  // Internal notes about how you work with them
  notes     String?  @map("notes")
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  jobs   Job[]

  @@map("client_companies")
}

// --------------------------------------------------------------------------
// JOBS
// --------------------------------------------------------------------------

model Job {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  externalId         String?  @map("external_id")
  title              String
  department         String?
  location           String?
  employmentType     String?  @map("employment_type")
  seniority          String?
  description        String?
  hiringManagerId    String?  @map("hiring_manager_id") @db.Uuid
  status             String   @default("open")   @db.Text
  visibility         String   @default("public") @db.Text
  tags               String[] @default([]) @db.Text
  createdBy          String?  @map("created_by") @db.Uuid
  createdAt          DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)
  slug               String?
  clientCompanyId    String?  @map("client_company_id") @db.Uuid
  workMode           String?  @map("work_mode")
  overview           String?
  aboutClient        String?  @map("about_client")
  responsibilities   String?
  requirements       String?
  benefits           String?
  shortDescription   String?  @map("short_description")
  locationType       String?  @map("location_type")
  experienceLevel    String?  @map("experience_level")
  yearsExperienceMin Int?     @map("years_experience_min")
  yearsExperienceMax Int?     @map("years_experience_max")
  salaryMin          Decimal? @map("salary_min")
  salaryMax          Decimal? @map("salary_max")
  salaryCurrency     String?  @map("salary_currency")
  salaryVisible      Boolean? @map("salary_visible")
  requiredSkills     String[] @default([]) @map("required_skills") @db.Text
  educationRequired  String?  @map("education_required")
  educationField     String?  @map("education_field")
  internalOnly       Boolean? @map("internal_only")
  confidential       Boolean? @map("confidential")
  screeningSchema    Json?    @map("screening_schema")

  // Scoring overrides per job
  hiringMode       String? @map("hiring_mode")       // override tenant.hiring_mode if set
  scoringOverrides Json?   @map("scoring_overrides") // per-job tweaks to weights/thresholds

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id])
  applications  JobApplication[]
  stages        JobStage[]
  sentEmails    SentEmail[]

  // scoring audit trail
  scoringEvents ScoringEvent[]

  // NEW: back-relation for AnalyticsSnapshot.job
  analyticsSnapshots AnalyticsSnapshot[]

  @@map("jobs")
}

// --------------------------------------------------------------------------
// CANDIDATES, TAGS & CANDIDATE TAGS
// --------------------------------------------------------------------------

model Candidate {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String   @map("tenant_id") @db.Uuid
  fullName       String   @map("full_name")
  email          String
  phone          String?
  location       String?
  linkedinUrl    String?  @map("linkedin_url")
  currentTitle   String?  @map("current_title")
  currentCompany String?  @map("current_company")
  cvUrl          String?  @map("cv_url")
  source         String?
  createdAt      DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  applications JobApplication[]
  tags         CandidateTag[]
  notes        Note[]
  sentEmails   SentEmail[]

  @@map("candidates")
}

model Tag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String
  color     String?
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  candidates CandidateTag[]

  @@map("tags")
}

model CandidateTag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  candidateId String   @map("candidate_id") @db.Uuid
  tagId       String   @map("tag_id") @db.Uuid
  createdAt   DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  candidate Candidate @relation(fields: [candidateId], references: [id])
  tag       Tag       @relation(fields: [tagId], references: [id])

  @@map("candidate_tags")
}

// --------------------------------------------------------------------------
// JOB APPLICATIONS, EVENTS & INTERVIEWS
// --------------------------------------------------------------------------

model JobApplication {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobId                  String    @map("job_id") @db.Uuid
  candidateId            String?   @map("candidate_id") @db.Uuid
  fullName               String    @map("full_name")
  email                  String
  phone                  String?
  location               String?
  linkedinUrl            String?   @map("linkedin_url")
  portfolioUrl           String?   @map("portfolio_url")
  cvUrl                  String?   @map("cv_url")
  coverLetter            String?   @map("cover_letter")
  source                 String?
  stage                  String    @default("APPLIED") @db.Text
  status                 String    @default("PENDING") @db.Text
  createdAt              DateTime  @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime  @map("updated_at") @default(now()) @db.Timestamptz(6)
  workPermitStatus       String?   @map("work_permit_status")
  grossAnnualExpectation String?   @map("gross_annual_expectation")
  currentGrossAnnual     String?   @map("current_gross_annual")
  noticePeriod           String?   @map("notice_period")
  githubUrl              String?   @map("github_url")
  screeningAnswers       Json?     @map("screening_answers")
  gender                 String?
  ethnicity              String?
  howHeard               String?   @map("how_heard")
  dataPrivacyConsent     Boolean?  @map("data_privacy_consent")
  termsConsent           Boolean?  @map("terms_consent")
  marketingOptIn         Boolean?  @map("marketing_opt_in")
  referenceCode          String?   @map("reference_code")
  statusNote             String?   @map("status_note")
  statusChangedAt        DateTime? @map("status_changed_at") @db.Timestamptz(6)

  // For auto-screening / ranking
  matchScore  Int?    @map("match_score")  // e.g. 0–100
  matchReason String? @map("match_reason") // short explanation / rationale

  job        Job        @relation(fields: [jobId], references: [id])
  candidate  Candidate? @relation(fields: [candidateId], references: [id])
  events     ApplicationEvent[]
  interviews ApplicationInterview[]
  notes      Note[]

  // scoring audit trail
  scoringEvents ScoringEvent[]

  @@map("job_applications")
}

model ApplicationEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  type          String
  payload       Json?    @map("payload")
  createdAt     DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  application JobApplication @relation(fields: [applicationId], references: [id])

  @@map("application_events")
}

// Richer interview model tied to an application
model ApplicationInterview {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  scheduledAt   DateTime @map("scheduled_at") @db.Timestamptz(6)
  type          String?  @map("type")      // PHONE, VIRTUAL, ONSITE, PANEL, etc.
  location      String?  @map("location")  // address or meeting room
  videoUrl      String?  @map("video_url") // e.g. Zoom/Meet link
  status        String   @map("status") @default("SCHEDULED") @db.Text // SCHEDULED, COMPLETED, NO_SHOW, CANCELLED
  durationMins  Int?     @map("duration_mins")
  notes         String?  @map("notes")
  createdAt     DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  application  JobApplication       @relation(fields: [applicationId], references: [id])
  participants InterviewParticipant[]

  @@map("application_interviews")
}

model InterviewParticipant {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  interviewId String   @map("interview_id") @db.Uuid
  name        String
  email       String
  role        String?  @map("role") // "Interviewer", "Candidate", "Observer", etc.
  createdAt   DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  interview ApplicationInterview @relation(fields: [interviewId], references: [id])

  @@map("interview_participants")
  @@index([interviewId], map: "idx_interview_participants_interview")
}

// --------------------------------------------------------------------------
// JOB STAGES
// --------------------------------------------------------------------------

model JobStage {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  jobId      String   @map("job_id") @db.Uuid
  name       String
  position   Int
  isTerminal Boolean  @map("is_terminal") @default(false)
  createdAt  DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  job    Job    @relation(fields: [jobId], references: [id])

  @@map("job_stages")
}

// --------------------------------------------------------------------------
// CAREER SITE SETTINGS
// --------------------------------------------------------------------------

model CareerSiteSettings {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  logoUrl      String?  @map("logo_url")
  primaryColor String?  @map("primary_color")
  accentColor  String?  @map("accent_color")
  heroTitle    String?  @map("hero_title")
  heroSubtitle String?  @map("hero_subtitle")
  aboutHtml    String?  @map("about_html")

  // NEW
  includeInMarketplace Boolean @map("include_in_marketplace") @default(false)

  isPublic  Boolean  @map("is_public") @default(true)
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("career_site_settings")
}

// --------------------------------------------------------------------------
// EMAIL TEMPLATES & SENT EMAILS
// --------------------------------------------------------------------------

model EmailTemplate {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  name         String
  templateType String?  @map("template_type")
  subject      String
  body         String
  isDefault    Boolean  @map("is_default") @default(false)
  createdById  String?  @map("created_by") @db.Uuid
  createdAt    DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  sentEmails SentEmail[]

  @@map("email_templates")
}

model SentEmail {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  templateId        String?  @map("template_id") @db.Uuid
  toEmail           String   @map("to_email")
  candidateId       String?  @map("candidate_id") @db.Uuid
  jobId             String?  @map("job_id") @db.Uuid
  subject           String
  body              String
  status            String   @default("sent") @db.Text
  errorMessage      String?  @map("error_message")
  providerMessageId String?  @map("provider_message_id")
  createdById       String?  @map("created_by") @db.Uuid
  sentAt            DateTime @map("sent_at") @default(now()) @db.Timestamptz(6)

  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  template  EmailTemplate? @relation(fields: [templateId], references: [id])
  candidate Candidate?     @relation(fields: [candidateId], references: [id])
  job       Job?           @relation(fields: [jobId], references: [id])

  @@map("sent_emails")
}

// --------------------------------------------------------------------------
// NOTES & ACTIVITY LOG
// --------------------------------------------------------------------------

model Note {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  candidateId   String?   @map("candidate_id") @db.Uuid
  applicationId String?   @map("application_id") @db.Uuid
  authorId      String    @map("author_id") @db.Uuid
  noteType      String?   @map("note_type") @default("general")
  body          String
  isPrivate     Boolean   @map("is_private") @default(false)
  createdAt     DateTime  @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  candidate   Candidate?      @relation(fields: [candidateId], references: [id])
  application JobApplication? @relation(fields: [applicationId], references: [id])

  @@map("notes")
}

model ActivityLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  actorId    String?  @map("actor_id") @db.Uuid
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id") @db.Uuid
  action     String
  metadata   Json?    @map("metadata")
  createdAt  DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("activity_log")
}

// --------------------------------------------------------------------------
// SCORING EVENTS (AUDIT TRAIL)
// --------------------------------------------------------------------------

model ScoringEvent {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  jobId         String?   @map("job_id") @db.Uuid
  applicationId String?   @map("application_id") @db.Uuid

  engine        String   @map("engine") // e.g. "semantic-v1"
  engineVersion String?  @map("engine_version")
  mode          String?  @map("mode")  // volume | executive | balanced
  score         Int?     @map("score")
  tier          String?  @map("tier")

  configSnapshot Json?   @map("config_snapshot") // scoring config used
  inputSummary   Json?   @map("input_summary")   // metadata about features
  reason         String? @map("reason")
  risks          Json?   @map("risks")           // list of risk strings
  redFlags       Json?   @map("red_flags")       // list of red-flag strings

  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant      Tenant          @relation(fields: [tenantId], references: [id])
  job         Job?            @relation(fields: [jobId], references: [id])
  application JobApplication? @relation(fields: [applicationId], references: [id])

  @@map("scoring_events")
  @@index([tenantId, jobId, applicationId], map: "idx_scoring_events_tenant_job_app")
}

// --------------------------------------------------------------------------
// SAVED VIEWS (FILTER PRESETS)
// --------------------------------------------------------------------------

model SavedView {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  ownerId   String?  @map("owner_id") @db.Uuid
  scope     String   @map("scope") // e.g. "job_applications", "candidates"
  name      String
  isShared  Boolean  @map("is_shared") @default(false)
  isDefault Boolean  @map("is_default") @default(false)
  filters   Json?    @map("filters") // persisted filters (stage, status, tier, query, etc.)
  sort      Json?    @map("sort")    // sort config

  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  owner  User?  @relation(fields: [ownerId], references: [id])

  @@map("saved_views")
  @@index([tenantId, scope], map: "idx_saved_views_tenant_scope")
}

// --------------------------------------------------------------------------
// ANALYTICS SNAPSHOTS
// --------------------------------------------------------------------------

model AnalyticsSnapshot {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String   @map("tenant_id") @db.Uuid
  jobId    String?  @map("job_id") @db.Uuid

  scope String  @map("scope") // e.g. "pipeline_daily", "source_breakdown"
  label String? @map("label") // e.g. "2025-12-05" or "last_30_days"

  asOf    DateTime @map("as_of") @db.Timestamptz(6)
  payload Json     @map("payload") // arbitrary JSON with metrics

  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  job    Job?   @relation(fields: [jobId], references: [id])

  @@map("analytics_snapshots")
  @@index([tenantId, scope, asOf], map: "idx_analytics_snapshots_scope_asof")
}
