// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // Supabase pooled URL
  directUrl = env("DIRECT_URL")     // Supabase direct URL
}

// --------------------------------------------------------------------------
// TENANTS
// --------------------------------------------------------------------------

model Tenant {
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug                String
  name                String
  status              String      @default("active")
  primaryContactEmail String?     @map("primary_contact_email")
  internalNotes       String?     @map("notes")
  createdAt           DateTime    @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime    @map("updated_at") @default(now()) @db.Timestamptz(6)

  // Relations
  jobs               Job[]
  clientCompanies    ClientCompany[]
  candidates         Candidate[]
  stages             JobStage[]
  careerSiteSettings CareerSiteSettings[]
  activityLog        ActivityLog[]
  emailTemplates     EmailTemplate[]
  candidateTags      CandidateTag[]
  notes              Note[]
  sentEmails         SentEmail[]
  userTenantRoles    UserTenantRole[]
  tags               Tag[]

  @@map("tenants")
}

// --------------------------------------------------------------------------
// USERS & USER â†” TENANT ROLES
// --------------------------------------------------------------------------

model User {
  id        String           @id @db.Uuid
  fullName  String?          @map("full_name")
  email     String?
  createdAt DateTime         @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt DateTime         @map("updated_at") @default(now()) @db.Timestamptz(6)

  userTenantRoles UserTenantRole[]

  @@map("users")
}

model UserTenantRole {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  role      String
  isPrimary Boolean  @map("is_primary") @default(false)
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@map("user_tenant_roles")
}

// --------------------------------------------------------------------------
// CLIENT COMPANIES
// --------------------------------------------------------------------------

model ClientCompany {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String
  slug      String?
  logoUrl   String?  @map("logo_url")
  createdAt DateTime @map("created_at") @default(now()) @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  jobs   Job[]

  @@map("client_companies")
}

// --------------------------------------------------------------------------
// JOBS
// --------------------------------------------------------------------------

model Job {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String    @map("tenant_id") @db.Uuid
  externalId         String?   @map("external_id")
  title              String
  department         String?
  location           String?
  employmentType     String?   @map("employment_type")
  seniority          String?
  description        String?
  hiringManagerId    String?   @map("hiring_manager_id") @db.Uuid
  status             String    @default("open")   @db.Text
  visibility         String    @default("public") @db.Text
  tags               String[]  @default([]) @db.Text
  createdBy          String?   @map("created_by") @db.Uuid
  createdAt          DateTime  @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @map("updated_at") @default(now()) @db.Timestamptz(6)
  slug               String?
  clientCompanyId    String?   @map("client_company_id") @db.Uuid
  workMode           String?   @map("work_mode")
  overview           String?
  aboutClient        String?   @map("about_client")
  responsibilities   String?
  requirements       String?
  benefits           String?
  shortDescription   String?   @map("short_description")
  locationType       String?   @map("location_type")
  experienceLevel    String?   @map("experience_level")
  yearsExperienceMin Int?      @map("years_experience_min")
  yearsExperienceMax Int?      @map("years_experience_max")
  salaryMin          Decimal?  @map("salary_min")
  salaryMax          Decimal?  @map("salary_max")
  salaryCurrency     String?   @map("salary_currency")
  salaryVisible      Boolean?  @map("salary_visible")
  requiredSkills     String[]  @default([]) @map("required_skills") @db.Text
  educationRequired  String?   @map("education_required")
  educationField     String?   @map("education_field")
  internalOnly       Boolean?  @map("internal_only")
  confidential       Boolean?  @map("confidential")
  screeningSchema    Json?     @map("screening_schema")

  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id])
  applications  JobApplication[]
  stages        JobStage[]
  sentEmails    SentEmail[]

  @@map("jobs")
}

// --------------------------------------------------------------------------
// CANDIDATES, TAGS & CANDIDATE TAGS
// --------------------------------------------------------------------------

model Candidate {
  id             String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String             @map("tenant_id") @db.Uuid
  fullName       String             @map("full_name")
  email          String
  phone          String?
  location       String?
  linkedinUrl    String?            @map("linkedin_url")
  currentTitle   String?            @map("current_title")
  currentCompany String?            @map("current_company")
  cvUrl          String?            @map("cv_url")
  source         String?
  createdAt      DateTime           @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime           @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  applications JobApplication[]
  tags         CandidateTag[]
  notes        Note[]
  sentEmails   SentEmail[]

  @@map("candidates")
}

model Tag {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String         @map("tenant_id") @db.Uuid
  name      String
  color     String?
  createdAt DateTime       @map("created_at") @default(now()) @db.Timestamptz(6)
  updatedAt DateTime       @map("updated_at") @default(now()) @db.Timestamptz(6)

  tenant     Tenant         @relation(fields: [tenantId], references: [id])
  candidates CandidateTag[]

  @@map("tags")
}

model CandidateTag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  can
